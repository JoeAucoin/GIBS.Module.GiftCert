@using GIBS.Module.GiftCert.Services
@using GIBS.Module.GiftCert.Models
@using Microsoft.AspNetCore.Components.Routing
@using System.ComponentModel.DataAnnotations
@using Oqtane.Modules.Controls
@using Oqtane.Shared
@using Oqtane.Services
@using Oqtane.Modules
@using Oqtane.Models
@using Oqtane.Interfaces @* Important for IInterop *@
@using Oqtane.UI
@using MimeKit
@using MailKit.Net.Smtp
@using MailKit.Security
@using Microsoft.JSInterop
@using System.Threading.Tasks
@using System.Text.Json
@using System.Text

@namespace GIBS.Module.GiftCert
@inherits ModuleBase
@implements IAsyncDisposable
@inject IGiftCertService GiftCertService
@inject NavigationManager NavigationManager
@inject IUserService UserService
@inject IStringLocalizer<Index> Localizer
@inject Oqtane.Services.ISettingService SettingService
@inject IJSRuntime JS
@inject Oqtane.Services.IPageService PageService




<form @ref="form" class="@(validated ? " was-validated" : "needs-validation")" novalidate>
    <div class="container">
        @if(_ShowFormFields)
        {
        <div class="moduleInstructions fs-3">@_ModuleInstructions</div>
        <div class="row mb-1 align-items-center">
            <Label Class="col-sm-3" For="certAmount" HelpText="Enter the certificate amount" ResourceKey="CertAmount">Amount: </Label>
            <div class="col-sm-9">
                    <input id="certAmount" type="number" step=".01" class="form-control form-control-lg" @bind="_giftCert.CertAmount" required />
            </div>
        </div>
        <div class="row mb-1 align-items-center">
            <Label Class="col-sm-3" For="toName" HelpText="Enter the recipient's name" ResourceKey="ToName">To Name: </Label>
            <div class="col-sm-9">
                <input id="toName" class="form-control form-control-lg" @bind="_giftCert.ToName" required />
            </div>
        </div>
        <div class="row mb-1 align-items-center">
            <Label Class="col-sm-3" For="fromName" HelpText="Enter the sender's name" ResourceKey="FromName">From Name: </Label>
            <div class="col-sm-9">
                <input id="fromName" class="form-control form-control-lg" @bind="_giftCert.FromName" required />
            </div>
        </div>
        <div class="row mb-1 align-items-center">
            <Label Class="col-sm-3" For="fromEmail" HelpText="Enter the sender's email" ResourceKey="FromEmail">From Email: </Label>
            <div class="col-sm-9">
                <input id="fromEmail" type="email" class="form-control form-control-lg" @bind="_giftCert.FromEmail" required />
            </div>
        </div>
            <div class="row mb-1 align-items-center">
                <label class="col-sm-3" for="fromPhone">From Phone: </label>
                <div class="col-sm-9">
                    <input id="fromPhone"
                           type="tel"
                           class="form-control form-control-lg"
                           placeholder="xxx-xxx-xxxx"
                           value="@_giftCert.FromPhone"
                           @onchange="HandlePhoneChange"
                           required />
                </div>
            </div>
        }

        @if(!_ShowFormFields)
        {
        <div class="row mb-1 align-items-center">
            <Label Class="col-sm-3"  HelpText="Certificate amount" ResourceKey="CertAmount">Amount: </Label>
            <div class="col-sm-9 fs-3">
                    $@_giftCert.CertAmount.ToString("N2")
            </div>
        </div>
        <div class="row mb-1 align-items-center">
            <Label Class="col-sm-3"  HelpText="Recipient's name" ResourceKey="ToName">To Name: </Label>
                <div class="col-sm-9 fs-3">
                @_giftCert.ToName
                </div>
            </div>
            <div class="row mb-1 align-items-center">
                <Label Class="col-sm-3"  HelpText="Sender's name" ResourceKey="FromName">From Name: </Label>
                <div class="col-sm-9 fs-3">
                    @_giftCert.FromName
                </div>
            </div>
            <div class="row mb-1 align-items-center">
                <Label Class="col-sm-3" HelpText="Sender's email" ResourceKey="FromEmail">From Email: </Label>
                <div class="col-sm-9 fs-3">
                    @_giftCert.FromEmail
                </div>
            </div>
            <div class="row mb-1 align-items-center">
                <Label Class="col-sm-3" HelpText="Sender's phone" ResourceKey="FromPhone">From Phone: </Label>
                <div class="col-sm-9 fs-3">
                    @_giftCert.FromPhone
                </div>
            </div>
        }
        @if (_ShowFormFields || _ShowShippingAddress)
        {
            <div class="row mb-1 align-items-center">
                <Label Class="col-sm-3" For="notes" HelpText="Enter any notes" ResourceKey="Notes">Note for Recipient: </Label>
                <div class="col-sm-9">
                    <textarea id="notes" class="form-control form-control-lg" @bind="_giftCert.Notes"></textarea>
                </div>
            </div>
        }

        @if(_ShowShippingAddress)
        {
        <div class="row mb-1 align-items-center">
            <Label Class="col-sm-3" For="mailTo" HelpText="Enter the name for mailing" ResourceKey="MailTo">Mail To Name: </Label>
            <div class="col-sm-9">
                <input id="mailTo" class="form-control form-control-lg" @bind="_giftCert.MailTo" />
            </div>
        </div>
        <div class="row mb-1 align-items-center">
            <Label Class="col-sm-3" For="mailToAddress" HelpText="Enter the mailing address" ResourceKey="MailToAddress">Mail To Address: </Label>
            <div class="col-sm-9">
                <input id="mailToAddress" class="form-control form-control-lg" @bind="_giftCert.MailToAddress" />
            </div>
        </div>
        <div class="row mb-1 align-items-center">
            <Label Class="col-sm-3" For="mailToAddress1" HelpText="Enter additional address info" ResourceKey="MailToAddress1">Address Line 2: </Label>
            <div class="col-sm-9">
                <input id="mailToAddress1" class="form-control form-control-lg" @bind="_giftCert.MailToAddress1" />
            </div>
        </div>
        <div class="row mb-1 align-items-center">
            <Label Class="col-sm-3" For="mailToCity" HelpText="Enter the city" ResourceKey="MailToCity">City: </Label>
            <div class="col-sm-9">
                <input id="mailToCity" class="form-control form-control-lg" @bind="_giftCert.MailToCity" />
            </div>
        </div>
        <div class="row mb-1 align-items-center">
            <Label Class="col-sm-3" For="mailToState" HelpText="Enter the state" ResourceKey="MailToState">State: </Label>
            <div class="col-sm-9">
                <input id="mailToState" class="form-control form-control-lg" @bind="_giftCert.MailToState" />
            </div>
        </div>
        <div class="row mb-1 align-items-center">
            <Label Class="col-sm-3" For="mailToZip" HelpText="Enter the ZIP code" ResourceKey="MailToZip">ZIP Code: </Label>
            <div class="col-sm-9">
                <input id="mailToZip" class="form-control form-control-lg" @bind="_giftCert.MailToZip" />
            </div>
        </div>
        }
       

        @if (_ShowButtons)
        {
            <div class="row mt-4">
                <div class="col-sm-9 offset-sm-3">

                    <button id="saveButton" type="button" class="btn btn-lg btn-success" @onclick="Save">@_ButtonText</button>
                    <NavLink class="btn btn-lg btn-secondary" href="@NavigateUrl()">@_CancelButtonText</NavLink>
                </div>
            </div>
        }

        <div id="paypal-button-container" class="paypal-button-container"></div>

      
    </div>
</form>
<div class="text-end"><ActionLink Action="List" Security="SecurityAccessLevel.Edit" Text="List GiftCert" ResourceKey="List" /></div>
@code {
    public override string RenderMode => RenderModes.Interactive;

    //    private Oqtane.UI.Interop _interop;

    private ElementReference form;
    private bool validated;
    private GiftCert _giftCert = new();
    private int _id = -1;
    private DotNetObjectReference<Index>? _dotNetRef;
    private bool _pendingPayPalInit = true;
    private bool _ShowShippingAddress = false;
    private bool _ShowFormFields = true;
    private bool _ShowButtons = true;
    private string _EmailReplyTo;
    private string _EmailBCC;
    private string _EmailNotify;
    private string _EmailSubject;
    private string _ModuleInstructions;
    private string _ButtonText = "Continue";
    private string _CancelButtonText = "Cancel";
    private decimal _DefaultValue = 25.00M;
    private bool _PayPalSandboxMode;
    private string _ClientId;       




    public override List<Resource> Resources => new List<Resource>()
    {
        new Resource { ResourceType = ResourceType.Stylesheet, Url = "_content/GIBS.Module.GiftCert/Module.css?v=1.0.4" },
        new Resource { ResourceType = ResourceType.Script, Level = ResourceLevel.Site, Url = "_content/GIBS.Module.GiftCert/Module.js?v=1.7" }

    };



    protected override async Task OnInitializedAsync()
    {
        try
        {
            var settings = await SettingService.GetModuleSettingsAsync(ModuleState.ModuleId);
            _PayPalSandboxMode = bool.Parse(SettingService.GetSetting(settings, "PayPalSandboxMode", "true"));
            if(_PayPalSandboxMode)
            {
                _ClientId = SettingService.GetSetting(settings, "PayPalSandboxClientId", "");
            }
            else
            {
                _ClientId = SettingService.GetSetting(settings, "OAuthClientId", "");
            }
            _EmailNotify = SettingService.GetSetting(settings, "EmailNotify", "");
            _EmailSubject = SettingService.GetSetting(settings, "EmailSubject", "Gift Certificate Created");
            _EmailBCC = SettingService.GetSetting(settings, "EmailBCC", "");
            _EmailReplyTo = SettingService.GetSetting(settings, "EmailReplyTo", "");
            _ModuleInstructions = SettingService.GetSetting(settings, "ModuleInstructions", "");
            _DefaultValue = decimal.Parse(SettingService.GetSetting(settings, "DefaultValue", "25"));


            if (PageState.QueryString?.TryGetValue("id", out var idStr) == true &&
                int.TryParse(idStr, out var parsedId))
            {
                _id = parsedId;
            }

            if (_id != -1 && PageState.User != null)
            {
                _giftCert = await GiftCertService.GetGiftCertAsync(_id, ModuleState.ModuleId) ?? new GiftCert();
            }
            else
            {
                _DefaultValue = Math.Max(_DefaultValue, 1.00M); // Ensure minimum value of 1.00
                _giftCert = new GiftCert { CertAmount = _DefaultValue };
                _giftCert.GiftCertId = 0;
                _giftCert.IP_Address = PageState.RemoteIPAddress;
                if (PageState.User != null)
                {
                    _giftCert.FromName = PageState.User.DisplayName;
                    _giftCert.FromEmail = PageState.User.Email;
                }
            }
        }
        catch (Exception ex)
        {
            await logger.LogError(ex, "Error Initializing GiftCert Form {Error}", ex.Message);
            AddModuleMessage(Localizer["Message.LoadError"], MessageType.Error);
        }
    }


    private void HandlePhoneChange(ChangeEventArgs e)
    {
        string input = e.Value?.ToString() ?? string.Empty;
        _giftCert.FromPhone = FormatPhoneNumber(input);
    }

    private string FormatPhoneNumber(string phone)
    {
        if (string.IsNullOrWhiteSpace(phone)) return phone;

        // Clean non-numeric characters
        var digitsOnly = new string(phone.Where(char.IsDigit).ToArray());

        if (digitsOnly.Length == 10)
        {
            return string.Format("{0:(###) ###-####}", double.Parse(digitsOnly));
        }

        // Return original if it doesn't match expected length
        return phone;
    }


    protected override async Task OnAfterRenderAsync(bool firstRender)
    {

        await base.OnAfterRenderAsync(firstRender);      

        if (!_pendingPayPalInit ||
            _giftCert?.GiftCertId <= 0 ||
            string.IsNullOrWhiteSpace(_giftCert.FromEmail))
        {
            return;
        }

        try
        {
            await InitializePayPalButtonsAsync();
            _pendingPayPalInit = false;
        }
        catch (JSException jsEx)
        {
            _pendingPayPalInit = true;
            await logger.LogError(jsEx, "Error initializing PayPal buttons {Error}", jsEx.Message);
        }
    }



    private async Task InitializePayPalButtonsAsync()
    {
        _ShowButtons = false; // Hide buttons
        _dotNetRef ??= DotNetObjectReference.Create(this);

        string url = "https://www.paypal.com/sdk/js?client-id=" + _ClientId + "&currency=USD";

        await JSRuntime.InvokeVoidAsync(
            "GIBS.GiftCert.loadPayPalSdk", url,
            _dotNetRef);
        
    }

    private async Task Save()
    {
        try
        {
            validated = true;
            var interop = new Oqtane.UI.Interop(JSRuntime);
            if (!await interop.FormValid(form))
            {
                AddModuleMessage(Localizer["Message.SaveValidation"], MessageType.Warning);
                return;
            }

            if (_id == -1)
            {
                _giftCert.ModuleId = ModuleState.ModuleId;
                _giftCert.PaypalPaymentState = "NOT-PAID";
                if (PageState.User != null)
                {
                    _giftCert.FromUserID = PageState.User.UserId;
                }
                var newCert = await GiftCertService.AddGiftCertAsync(_giftCert);

                _id = newCert.GiftCertId;
                _giftCert.GiftCertId = newCert.GiftCertId;

                await logger.LogInformation("Gift Certificate Added {GiftCert}", newCert);
                AddModuleMessage(Localizer["Message.SaveSuccess"], MessageType.Success);
                _ShowFormFields = false;
                _ShowButtons = false;

            }
            else
            {
                _giftCert = await GiftCertService.UpdateGiftCertAsync(_giftCert);
                await logger.LogInformation("Gift Certificate Updated {GiftCert}", _giftCert);
                AddModuleMessage(Localizer["Message.UpdateSuccess"], MessageType.Success);
            }

            if (_ButtonText == "Update Mailing Address")
            {
                AddModuleMessage(Localizer["Message.ShippingUpdateSuccess"], MessageType.Success);


                
                _ShowButtons = false; // Hide buttons
                _ShowShippingAddress = false;
                _ShowFormFields = false;

                var currentUrl = NavigationManager.Uri;
                var baseUri = NavigationManager.BaseUri;
                //var site = ModuleState.SiteId; //
                //var request = _accessor.HttpContext.Request;
                var mySite = $"{currentUrl.ToString()}";

                var body = new StringBuilder();
                body.AppendLine($"<p>You have successfully updated the mailing address for this Gift Certificate:</p>");
                body.AppendLine($"<p><b>From:</b> {_giftCert.FromName}</p>");
                body.AppendLine($"<p><b>Recipient:</b> {_giftCert.ToName}</p>");
                body.AppendLine($"<p><b>Amount:</b> ${_giftCert.CertAmount}</p>");
                body.AppendLine($"<p><b>Your Phone:</b> {_giftCert.FromPhone}</p>");
                body.AppendLine($"<p><b>Email:</b> {_giftCert.FromEmail}</p>");
                body.AppendLine($"<p><b>Mail To:</b><br />{_giftCert.MailTo}<br />{_giftCert.MailToAddress}<br />{(!string.IsNullOrEmpty(_giftCert.MailToAddress1) ? _giftCert.MailToAddress1 + "<br />" : "")}{_giftCert.MailToCity}, {_giftCert.MailToState} {_giftCert.MailToZip}</p>");

                body.AppendLine($"<p><b>Notes:</b></p>");
                body.AppendLine($"<p>{_giftCert.Notes}</p>");
                body.AppendLine($"<hr />");
                body.AppendLine($"<p><b>Submitted On:</b> {_giftCert.CreatedOn}</p>");
                body.AppendLine($"<p><b>IP Address:</b> https://ip-address-lookup-v4.com/ip/{_giftCert.IP_Address}</p>");
                body.AppendLine($"<p><b>Site:</b> " + mySite.ToString() + "</p>");

                //Notify purchaser of address update
                await GiftCertService.SendHtmlEmailAsync(
                    _giftCert.FromName,               // Recipient Name
                    _giftCert.FromEmail,            // Recipient Email (or wherever you want it to go)
                    _EmailBCC,            // BCC Name
                    _EmailBCC,               // BCC Email
                    _EmailReplyTo,
                    _EmailReplyTo,     // ReplyTo Email
                  "Mailing Address Updated: " + _EmailSubject + " " + _giftCert.ToName,     // Subject
                 body.ToString());

                //NOTIFY ADMIN OF ADDRESS UPDATE
                await GiftCertService.SendHtmlEmailAsync(
                    "Gift Certificate Admin",               // Recipient Name
                    _EmailNotify,            // Recipient Email (or wherever you want it to go)
                    _EmailBCC,            // BCC Name
                    _EmailBCC,               // BCC Email
                    _giftCert.FromName,               // Recipient Name
                    _giftCert.FromEmail,            // Recipient Email (or wherever you want it to go)
                  "Mailing Address Updated: " + _EmailSubject + " " + _giftCert.ToName,     // Subject
                 body.ToString());

                 

                return;
            }

            // await SendHtmlEmailAsync(
            //     "joseph.m.aucoin@gmail.com",
            //     "Gift Certificate Created",
            //     $"<h1>Your gift certificate for ${_giftCert.CertAmount:F2} has been created successfully.</h1>");
            // UPDATED CALL


            _pendingPayPalInit = true;
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            await logger.LogError(ex, "Error Saving Gift Certificate {Error}", ex.Message);
            AddModuleMessage(Localizer["Message.SaveError"], MessageType.Error);
        }
    }

    [JSInvokable]
    public async Task<string> CreateOrderOnServer()
    {
        try
        {
            var orderResponse = await GiftCertService.CreatePayPalOrderAsync(_giftCert);
            if (orderResponse != null && !string.IsNullOrEmpty(orderResponse.OrderId))
            {
                await logger.LogInformation("PayPal Order Created On Server with ID: {OrderId}", orderResponse.OrderId);
                return orderResponse.OrderId;
            }
            else
            {
                await logger.LogError("Failed to create PayPal order on server.");
                return string.Empty;
            }
        }
        catch (Exception ex)
        {
            await logger.LogError(ex, "Error Creating PayPal Order On Server {Error}", ex.Message);
            return string.Empty;
        }
    }

    [JSInvokable]
    public async Task<object> CaptureOrderOnServer(string orderId)
    {
        try
        {
            var resultJson = await GiftCertService.CapturePayPalOrderAsync(orderId, ModuleState.ModuleId);
            if (string.IsNullOrEmpty(resultJson))
            {
                throw new Exception("Server returned an empty response for order capture.");
            }

            AddModuleMessage(resultJson, MessageType.Success);

            using var jsonDoc = JsonDocument.Parse(resultJson);
            var root = jsonDoc.RootElement;

            // The PayPal v2 Orders API returns "status": "COMPLETED" on successful capture.  APPROVED
            if (root.TryGetProperty("Status", out var statusElement) &&
              (statusElement.ValueKind == JsonValueKind.String && statusElement.GetString().Equals("COMPLETED", StringComparison.OrdinalIgnoreCase) ||
               statusElement.ValueKind == JsonValueKind.Number && statusElement.GetInt32() == 4))

            {
                // get the return PayPal id from json
                var paypalid = root.GetProperty("Id").GetString();
                _giftCert.PP_Response = resultJson;
                _giftCert.PaypalPaymentState = "PAID";
                _giftCert.isProcessed = false;
                _giftCert.PP_PaymentId = paypalid;

                // Safely parse the shipping address from the JSON response
                if (root.TryGetProperty("PurchaseUnits", out var purchaseUnits) && purchaseUnits.GetArrayLength() > 0)
                {
                    var firstPurchaseUnit = purchaseUnits[0];
                    if (firstPurchaseUnit.TryGetProperty("Shipping", out var shipping))
                    {
                        if (shipping.TryGetProperty("Name", out var name) && name.TryGetProperty("FullName", out var fullName))
                        {
                            _giftCert.MailTo = fullName.GetString();
                        }

                        if (shipping.TryGetProperty("Address", out var address))
                        {
                            if (address.TryGetProperty("AddressLine1", out var addressLine1))
                            {
                                _giftCert.MailToAddress = addressLine1.GetString();
                            }
                            if (address.TryGetProperty("AddressLine2", out var addressLine2))
                            {
                                _giftCert.MailToAddress1 = addressLine2.GetString();
                            }
                            if (address.TryGetProperty("AdminArea2", out var city))
                            {
                                _giftCert.MailToCity = city.GetString();
                            }
                            if (address.TryGetProperty("AdminArea1", out var state))
                            {
                                _giftCert.MailToState = state.GetString();
                            }
                            if (address.TryGetProperty("PostalCode", out var postalCode))
                            {
                                _giftCert.MailToZip = postalCode.GetString();
                            }
                        }
                    }
                }


                var updateCert = await GiftCertService.UpdateGiftCertAsync(_giftCert);

                _ShowButtons = true; // Show buttons
                _ButtonText = "Update Shipping Address";
                _CancelButtonText = "All Set, Looks Good";

                var currentUrl = NavigationManager.Uri;
                var baseUri = NavigationManager.BaseUri;
                //var site = ModuleState.SiteId; //
                //var request = _accessor.HttpContext.Request;
                var mySite = $"{currentUrl.ToString()}";

                var body = new StringBuilder();
                body.AppendLine($"<p>You have successfully ordered a new Gift Certificate:</p>");
                body.AppendLine($"<p><b>From:</b> {_giftCert.FromName}</p>");
                body.AppendLine($"<p><b>Recipient:</b> {_giftCert.ToName}</p>");
                body.AppendLine($"<p><b>Amount:</b> ${_giftCert.CertAmount}</p>");
                body.AppendLine($"<p><b>Your Phone:</b> {_giftCert.FromPhone}</p>");
                body.AppendLine($"<p><b>Email:</b> {_giftCert.FromEmail}</p>");
                body.AppendLine($"<p><b>Mail To:</b><br />{_giftCert.MailTo}<br />{_giftCert.MailToAddress}<br />{(!string.IsNullOrEmpty(_giftCert.MailToAddress1) ? _giftCert.MailToAddress1 + "<br />" : "")}{_giftCert.MailToCity}, {_giftCert.MailToState} {_giftCert.MailToZip}</p>");

                body.AppendLine($"<p><b>Notes:</b></p>");
                body.AppendLine($"<p>{_giftCert.Notes}</p>");
                body.AppendLine($"<hr />");
                body.AppendLine($"<p><b>Submitted On:</b> {_giftCert.CreatedOn}</p>");
                body.AppendLine($"<p><b>IP Address:</b> https://ip-address-lookup-v4.com/ip/{_giftCert.IP_Address}</p>");
                body.AppendLine($"<p><b>Site:</b> " + mySite.ToString() + "</p>");

                // notify purchaser
                await GiftCertService.SendHtmlEmailAsync(
                  _giftCert.FromName,               // Recipient Name
                  _giftCert.FromEmail,            // Recipient Email (or wherever you want it to go)
                  _EmailBCC,            // BCC Name
                  _EmailBCC,               // BCC Email
                  _EmailReplyTo,  
                    _EmailReplyTo,     // ReplyTo Email
                  _EmailSubject + " " + _giftCert.ToName,     // Subject
                 body.ToString());

                 // NOTIFY ADMIN
                 await GiftCertService.SendHtmlEmailAsync(
                    "Gift Certificate Admin",               // Recipient Name
                    _EmailNotify,            // Recipient Email (or wherever you want it to go)
                    _EmailBCC,            // BCC Name
                    _EmailBCC,               // BCC Email
                    _giftCert.FromName,               // Recipient Name
                    _giftCert.FromEmail,            // Recipient Email (or wherever you want it to go)
                 _EmailSubject + " " + _giftCert.ToName,     // Subject
                   body.ToString());

                //$"<h1>Your gift certificate for ${_giftCert.CertAmount:F2} to {_giftCert.ToName} has been created successfully.</h1>"); // Body

                // Hide the PayPal buttons and show a success message
                var interop = new Oqtane.UI.Interop(JSRuntime);

                await JS.InvokeVoidAsync("eval", "document.getElementById('paypal-button-container').style.display = 'none';");

                 _ShowShippingAddress = true;

                AddModuleMessage(Localizer["Message.PaymentSuccess"], MessageType.Success);
                await InvokeAsync(StateHasChanged);

                return new { status = "COMPLETED" };
            }
            else if (root.TryGetProperty("name", out var errorName) &&
                     errorName.GetString() == "INSTRUMENT_DECLINED")
            {
                await logger.LogWarning("PayPal payment failed: Instrument Declined. Order ID: {OrderId}", orderId);
                return new { error = "INSTRUMENT_DECLINED" };
            }
            else
            {
                await logger.LogError("PayPal capture was not completed. Status: {Status}. Response: {Response}",
                    root.TryGetProperty("status", out var s) ? s.GetString() : "Unknown", resultJson);
                return string.Empty;
                //   throw new Exception("PayPal payment could not be completed.");
            }
        }
        catch (Exception ex)
        {
            await logger.LogError(ex, "Error Capturing PayPal Order On Server for Order {OrderId}", orderId);
            return string.Empty;
            //  throw; // Re-throw the exception to be caught by the JavaScript caller
        }
    }

    [JSInvokable]
    public async Task PersistPayPalCaptureAsync(string orderId, string transactionId, string status)
    {
        _giftCert.PP_PaymentId = transactionId;
        _giftCert.PaypalPaymentState = status;
        _giftCert.PP_Response = orderId;
        _giftCert.isProcessed = string.Equals(status, "COMPLETED", StringComparison.OrdinalIgnoreCase);

        await GiftCertService.UpdateGiftCertAsync(_giftCert);
        AddModuleMessage(Localizer["Message.PaymentCaptured"], MessageType.Success);
    }

    private async Task CreateOrderAsync()
    {
        var dto = await GiftCertService.CreatePayPalOrderAsync(_giftCert);


    }

    public ValueTask DisposeAsync()
    {
        _dotNetRef?.Dispose();
        return ValueTask.CompletedTask;
    }
}